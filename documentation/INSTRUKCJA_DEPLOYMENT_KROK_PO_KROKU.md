# üöÄ INSTRUKCJA DEPLOYMENT - KROK PO KROKU

**Data:** 2025-01-12  
**Status:** GOTOWE DO WDRO≈ªENIA  
**Czas:** ~45 minut

---

## üìã PODSUMOWANIE ZROBIONYCH ZMIAN

### ‚úÖ CO ZOSTA≈ÅO DODANE DO SYSTEMU ABONAMENTOWEGO:

#### 1. **Baza Danych (Supabase)**
- ‚úÖ **3 nowe tabele:**
  - `subscription_payments` - historia p≈Çatno≈õci (‚Ç¨13/miesiƒÖc)
  - `certificate_applications` - wnioski o certyfikat Premium
  - `subscription_events` - audit log wszystkich zdarze≈Ñ
  
- ‚úÖ **12 nowych kolumn w tabeli `workers`:**
  ```sql
  subscription_tier           -- 'basic' | 'premium'
  subscription_status         -- 'active' | 'cancelled' | 'expired'
  subscription_start_date
  subscription_end_date
  last_payment_date
  monthly_fee                 -- ‚Ç¨13.00
  stripe_customer_id          -- Link do Stripe
  stripe_subscription_id      -- Link do Stripe
  zzp_certificate_issued      -- Czy ma certyfikat
  zzp_certificate_date
  zzp_certificate_number      -- ZZP-00000001
  zzp_certificate_expires_at
  ```

- ‚úÖ **RLS Policies (bezpiecze≈Ñstwo):**
  - Workers widzƒÖ tylko swoje p≈Çatno≈õci i aplikacje
  - Admins widzƒÖ wszystko
  - Automatyczna ochrona danych

- ‚úÖ **View dla Admin Dashboard:**
  - `v_active_subscriptions` - szybki przeglƒÖd aktywnych subskrypcji

#### 2. **Stripe Configuration**
- ‚úÖ 4 produkty do utworzenia w Stripe:
  - Worker Premium: **‚Ç¨13/miesiƒÖc** (recurring subscription)
  - ZZP Exam: **‚Ç¨230 jednorazowo** (one-time payment)
  - Employer Basic: **‚Ç¨13/miesiƒÖc**
  - Employer Premium: **‚Ç¨25/miesiƒÖc**

#### 3. **Frontend Components**
- ‚úÖ `SubscriptionPanel.tsx` - panel abonamentu w Worker Dashboard
- ‚úÖ `EmployerPaywall.tsx` - blokada dla employers bez abonamentu
- ‚úÖ `ZZPExamApplicationForm.tsx` - formularz zg≈Çoszeniowy na egzamin
- ‚úÖ `ZZPCertificateBadge.tsx` - badge certyfikatu na profilu
- ‚úÖ `CheckoutButton.tsx` - przycisk p≈Çatno≈õci Stripe

#### 4. **Backend (Supabase Edge Functions)**
- ‚úÖ `create-checkout-session` - tworzy Stripe Checkout URL
- ‚úÖ `stripe-webhook` - obs≈Çuguje webhooks z Stripe
- ‚úÖ `create-exam-payment` - obs≈Çuguje p≈Çatno≈õƒá za egzamin (‚Ç¨230)

#### 5. **Routing & Protection**
- ‚úÖ `ProtectedRoute` - blokuje dostƒôp bez aktywnego abonamentu
- ‚úÖ Employer routes wymagajƒÖ `subscription_status = 'active'`
- ‚úÖ Workers z `basic` tier niewidoczni dla employers

---

## üóÑÔ∏è KROK 1: MIGRACJA BAZY DANYCH SUPABASE

### A) Otw√≥rz Supabase Dashboard

1. Id≈∫ na: **https://supabase.com/dashboard**
2. Zaloguj siƒô
3. Wybierz sw√≥j projekt **ZZP Werkplaats**
4. Kliknij **SQL Editor** w lewym menu bocznym

### B) Uruchom migracjƒô SQL

1. **Skopiuj CA≈ÅƒÑ zawarto≈õƒá** pliku:
   ```
   SUBSCRIPTION_SYSTEM_MIGRATION.sql
   ```
   (455 linii kodu SQL)

2. **Wklej** do SQL Editor w Supabase

3. **Kliknij RUN** (lub naci≈õnij `Ctrl + Enter`)

### C) Sprawd≈∫ wynik

Powiniene≈õ zobaczyƒá komunikat:
```
‚úÖ MIGRACJA ZAKO≈ÉCZONA POMY≈öLNIE!
========================================
Workers og√≥≈Çem: X
Basic tier: Y
Premium tier: Z

üìã Utworzone tabele:
  ‚úÖ subscription_payments
  ‚úÖ certificate_applications
  ‚úÖ subscription_events

üîí RLS Policies: ‚úÖ Aktywne
üìä Views: ‚úÖ v_active_subscriptions
```

### D) Weryfikacja rƒôczna

1. Kliknij **Table Editor** w lewym menu
2. Sprawd≈∫ czy istniejƒÖ tabele:
   - ‚úÖ `subscription_payments`
   - ‚úÖ `certificate_applications`
   - ‚úÖ `subscription_events`

3. Otw√≥rz tabelƒô `workers`
4. Sprawd≈∫ czy widzisz nowe kolumny:
   - `subscription_tier`
   - `subscription_status`
   - `stripe_customer_id`
   - `zzp_certificate_issued`
   - itd.

### ‚ö†Ô∏è Je≈õli pojawi siƒô b≈ÇƒÖd:

- **B≈ÇƒÖd: "column already exists"**
  ‚Üí To normalne! Czƒô≈õƒá kolumn ju≈º istnia≈Ça. Migracja bezpiecznie je pomija.

- **B≈ÇƒÖd: "table does not exist"**
  ‚Üí Sprawd≈∫ czy tabela `workers` i `profiles` istniejƒÖ w Database

- **Inny b≈ÇƒÖd:**
  ‚Üí Skopiuj tre≈õƒá b≈Çƒôdu i napisz do mnie, naprawiƒô

---

## üí≥ KROK 2: KONFIGURACJA STRIPE

### A) Utw√≥rz konto Stripe (Test Mode)

1. Id≈∫ na: **https://dashboard.stripe.com/register**
2. Zarejestruj siƒô (wybierz kraj: **Netherlands**)
3. **NIE AKTYWUJ LIVE MODE** - zosta≈Ñ w **Test Mode** (prze≈ÇƒÖcznik w prawym g√≥rnym rogu)

### B) Pobierz klucze API

1. Id≈∫ na: **https://dashboard.stripe.com/test/apikeys**
2. Skopiuj:
   - **Publishable key** ‚Üí zaczyna siƒô od `pk_test_...`
   - **Secret key** ‚Üí kliknij "Reveal", zaczyna siƒô od `sk_test_...`

### C) Utw√≥rz produkty w Stripe

#### Produkt 1: Worker Premium Subscription

1. Id≈∫ na: **https://dashboard.stripe.com/test/products/create**
2. Wype≈Çnij formularz:
   ```
   Name: Premium Worker Subscription
   Description: Maandelijks abonnement voor meer zichtbaarheid
   Price: ‚Ç¨13.00
   Billing period: Monthly
   ```
3. Kliknij **Save product**
4. **SKOPIUJ `Price ID`** (zaczyna siƒô od `price_...`)
   ‚Üí Zapisz jako: `VITE_STRIPE_PRICE_WORKER_PREMIUM`

#### Produkt 2: ZZP Exam & Certification

1. **Create new product**:
   ```
   Name: ZZP Exam & Certification
   Description: Eenmalige betaling voor praktijkexamen + certificaat
   Price: ‚Ç¨230.00
   Billing period: One time
   ```
2. Kliknij **Save product**
3. **SKOPIUJ `Price ID`**
   ‚Üí Zapisz jako: `VITE_STRIPE_PRICE_ZZP_EXAM`

#### Produkt 3: Employer Basic

1. **Create new product**:
   ```
   Name: Employer Basic Plan
   Description: Basis toegang - 50 zoekopdrachten, 5 contacten per maand
   Price: ‚Ç¨13.00
   Billing period: Monthly
   ```
2. **SKOPIUJ `Price ID`**
   ‚Üí Zapisz jako: `VITE_STRIPE_PRICE_EMPLOYER_BASIC`

#### Produkt 4: Employer Premium

1. **Create new product**:
   ```
   Name: Employer Premium Plan
   Description: Volledige toegang - Unlimited searches en contacten
   Price: ‚Ç¨25.00
   Billing period: Monthly
   ```
2. **SKOPIUJ `Price ID`**
   ‚Üí Zapisz jako: `VITE_STRIPE_PRICE_EMPLOYER_PREMIUM`

### D) Skonfiguruj Webhook

1. Id≈∫ na: **https://dashboard.stripe.com/test/webhooks/create**
2. Kliknij **Add endpoint**
3. Endpoint URL:
   ```
   https://YOUR_SUPABASE_PROJECT_ID.supabase.co/functions/v1/stripe-webhook
   ```
   (ZastƒÖp `YOUR_SUPABASE_PROJECT_ID` swoim ID projektu)

4. **Select events to listen to:**
   - `checkout.session.completed`
   - `customer.subscription.created`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`
   - `invoice.payment_succeeded`
   - `invoice.payment_failed`

5. Kliknij **Add endpoint**
6. **SKOPIUJ `Signing secret`** (zaczyna siƒô od `whsec_...`)
   ‚Üí Zapisz jako: `STRIPE_WEBHOOK_SECRET`

---

## üîß KROK 3: KONFIGURACJA ENVIRONMENT VARIABLES

### A) Utw√≥rz plik `.env` w g≈Ç√≥wnym katalogu projektu

```bash
# =====================================================
# ZZP WERKPLAATS - Environment Variables
# =====================================================

# ----------------
# Supabase Config
# ----------------
VITE_SUPABASE_URL=https://TWOJ_PROJECT_ID.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhb... (tw√≥j anon key)

# ----------------
# Stripe Payment Config
# ----------------
# Frontend Keys (prefix VITE_)
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_... (z KROKU 2B)

# Price IDs (z KROKU 2C)
VITE_STRIPE_PRICE_WORKER_PREMIUM=price_... (Worker Premium)
VITE_STRIPE_PRICE_ZZP_EXAM=price_... (ZZP Exam)
VITE_STRIPE_PRICE_EMPLOYER_BASIC=price_... (Employer Basic)
VITE_STRIPE_PRICE_EMPLOYER_PREMIUM=price_... (Employer Premium)

# Backend Keys (DO NOT prefix VITE_)
STRIPE_SECRET_KEY=sk_test_... (z KROKU 2B)
STRIPE_WEBHOOK_SECRET=whsec_... (z KROKU 2D)

# ----------------
# Application Config
# ----------------
VITE_APP_VERSION=1.0.0
VITE_APP_NAME=ZZP Werkplaats
```

### B) Dodaj `.env` do Supabase Edge Functions

1. Otw√≥rz Supabase Dashboard
2. Id≈∫ na: **Edge Functions** ‚Üí **Settings**
3. Dodaj zmienne ≈õrodowiskowe:
   ```
   STRIPE_SECRET_KEY=sk_test_...
   STRIPE_WEBHOOK_SECRET=whsec_...
   SUPABASE_URL=https://TWOJ_PROJECT_ID.supabase.co
   SUPABASE_SERVICE_ROLE_KEY=eyJhb... (service role key z Settings > API)
   ```

---

## üöÄ KROK 4: DEPLOY SUPABASE EDGE FUNCTIONS

### A) Zainstaluj Supabase CLI

```bash
# Windows (PowerShell)
scoop bucket add supabase https://github.com/supabase/scoop-bucket.git
scoop install supabase

# Mac
brew install supabase/tap/supabase

# Weryfikacja instalacji
supabase --version
```

### B) Zaloguj siƒô do Supabase

```bash
supabase login
```
(Otworzy przeglƒÖdarkƒô do autoryzacji)

### C) Link projektu

```bash
supabase link --project-ref YOUR_PROJECT_ID
```
(Znajd≈∫ PROJECT_ID w Settings > General)

### D) Deploy funkcji

```bash
# Deploy wszystkich funkcji
supabase functions deploy create-checkout-session
supabase functions deploy stripe-webhook
supabase functions deploy create-exam-payment

# Sprawd≈∫ status
supabase functions list
```

### E) Ustaw environment variables dla funkcji

```bash
supabase secrets set STRIPE_SECRET_KEY=sk_test_...
supabase secrets set STRIPE_WEBHOOK_SECRET=whsec_...
supabase secrets set SUPABASE_URL=https://...
supabase secrets set SUPABASE_SERVICE_ROLE_KEY=eyJhb...
```

---

## ‚úÖ KROK 5: TESTOWANIE SYSTEMU

### A) Test p≈Çatno≈õci Worker Premium (‚Ç¨13/miesiƒÖc)

1. Uruchom aplikacjƒô lokalnie:
   ```bash
   npm run dev
   ```

2. Zaloguj siƒô jako **Worker**

3. Id≈∫ do: **Dashboard** ‚Üí **Subskrypcja**

4. Kliknij **"Upgrade naar Premium"**

5. Zostaniesz przekierowany do Stripe Checkout

6. U≈ºyj **testowej karty** Stripe:
   ```
   Card number: 4242 4242 4242 4242
   Expiry: 12/34
   CVC: 123
   ZIP: 12345
   ```

7. Doko≈Ñcz p≈Çatno≈õƒá

8. Sprawd≈∫ w Supabase:
   - **Table Editor** ‚Üí `workers` ‚Üí tw√≥j rekord
   - `subscription_status` = `'active'`
   - `subscription_tier` = `'premium'`
   - `stripe_customer_id` = `cus_...`
   - `stripe_subscription_id` = `sub_...`

9. Sprawd≈∫ w Stripe Dashboard:
   - **https://dashboard.stripe.com/test/subscriptions**
   - Powinna byƒá nowa subskrypcja

### B) Test p≈Çatno≈õci ZZP Exam (‚Ç¨230 jednorazowo)

1. Jako Worker, id≈∫ do: **/worker/zzp-exam-application**

2. Wype≈Çnij formularz zg≈Çoszeniowy

3. Kliknij **"Betaal ‚Ç¨230"**

4. Doko≈Ñcz p≈Çatno≈õƒá testowƒÖ

5. Sprawd≈∫ w Supabase:
   - **Table Editor** ‚Üí `zzp_exam_applications`
   - Nowy rekord z `status = 'pending_payment'` lub `'scheduled'`

### C) Test Admin Panel

1. Zaloguj siƒô jako **Admin**

2. Id≈∫ do: **/admin/zzp-exams**

3. Powiniene≈õ zobaczyƒá zg≈Çoszenie z poprzedniego testu

4. Kliknij **"Oce≈Ñ egzamin"**

5. Wpisz ocenƒô (1-10), notatki

6. Kliknij **"Pass" + "Wystaw Certyfikat"**

7. Sprawd≈∫ w Supabase:
   - **Table Editor** ‚Üí `workers`
   - Worker powinien mieƒá:
     - `zzp_certificate_issued = true`
     - `zzp_certificate_number = 'ZZP-2025-00001'`
     - `subscription_tier = 'premium'` (auto-upgrade)

### D) Test Employer Paywall

1. Zaloguj siƒô jako **Employer** (BEZ aktywnego abonamentu)

2. Spr√≥buj wej≈õƒá na: **/employer/search**

3. Powiniene≈õ zostaƒá przekierowany na: **/employer/subscription**

4. Zobaczyƒá ≈Çadny **EmployerPaywall** z cenami:
   - Basic: ‚Ç¨13/miesiƒÖc
   - Premium: ‚Ç¨25/miesiƒÖc

5. Kliknij **"Start Basic Plan"**

6. Doko≈Ñcz p≈Çatno≈õƒá testowƒÖ

7. Teraz powiniene≈õ mieƒá dostƒôp do search

---

## üìä WERYFIKACJA KO≈ÉCOWA

### Checklist - Co powinno dzia≈Çaƒá:

- [ ] ‚úÖ Baza danych: 3 nowe tabele utworzone
- [ ] ‚úÖ Workers: 12 nowych kolumn w tabeli
- [ ] ‚úÖ Stripe: 4 produkty utworzone (Premium, Exam, Basic, Premium Employer)
- [ ] ‚úÖ Environment: wszystkie klucze API ustawione
- [ ] ‚úÖ Edge Functions: 3 funkcje deployed
- [ ] ‚úÖ Test p≈Çatno≈õci Worker Premium: dzia≈Ça
- [ ] ‚úÖ Test p≈Çatno≈õci ZZP Exam: dzia≈Ça
- [ ] ‚úÖ Test Admin Panel: dzia≈Ça
- [ ] ‚úÖ Test Employer Paywall: blokuje dostƒôp bez subskrypcji
- [ ] ‚úÖ Stripe Dashboard: p≈Çatno≈õci widoczne
- [ ] ‚úÖ Supabase: dane zapisujƒÖ siƒô poprawnie

---

## üéØ CO DOK≈ÅADNIE MUSISZ WKLEIƒÜ/SKONFIGUROWAƒÜ:

### 1Ô∏è‚É£ **W SUPABASE SQL EDITOR:**
```sql
-- Wklej ca≈ÇƒÖ zawarto≈õƒá pliku:
SUBSCRIPTION_SYSTEM_MIGRATION.sql
```
**Gdzie:** Supabase Dashboard ‚Üí SQL Editor ‚Üí Run

---

### 2Ô∏è‚É£ **W STRIPE DASHBOARD:**

**Produkty do utworzenia (4 sztuki):**

| Nazwa | Cena | Typ | Price ID ‚Üí zapisz jako |
|-------|------|-----|------------------------|
| Premium Worker Subscription | ‚Ç¨13 | Monthly | `VITE_STRIPE_PRICE_WORKER_PREMIUM` |
| ZZP Exam & Certification | ‚Ç¨230 | One-time | `VITE_STRIPE_PRICE_ZZP_EXAM` |
| Employer Basic Plan | ‚Ç¨13 | Monthly | `VITE_STRIPE_PRICE_EMPLOYER_BASIC` |
| Employer Premium Plan | ‚Ç¨25 | Monthly | `VITE_STRIPE_PRICE_EMPLOYER_PREMIUM` |

**Gdzie:** https://dashboard.stripe.com/test/products/create

---

### 3Ô∏è‚É£ **W PLIKU `.env` (g≈Ç√≥wny katalog projektu):**

```bash
# Supabase (z Dashboard ‚Üí Settings ‚Üí API)
VITE_SUPABASE_URL=https://TWOJ_PROJECT_ID.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGci...

# Stripe API Keys (z Dashboard ‚Üí Developers ‚Üí API keys)
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_...
STRIPE_SECRET_KEY=sk_test_...

# Stripe Price IDs (z poprzedniego kroku - produkty)
VITE_STRIPE_PRICE_WORKER_PREMIUM=price_...
VITE_STRIPE_PRICE_ZZP_EXAM=price_...
VITE_STRIPE_PRICE_EMPLOYER_BASIC=price_...
VITE_STRIPE_PRICE_EMPLOYER_PREMIUM=price_...

# Stripe Webhook (z Dashboard ‚Üí Webhooks ‚Üí po dodaniu endpointu)
STRIPE_WEBHOOK_SECRET=whsec_...
```

---

### 4Ô∏è‚É£ **W SUPABASE EDGE FUNCTIONS (Dashboard ‚Üí Edge Functions ‚Üí Settings):**

```bash
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
SUPABASE_URL=https://TWOJ_PROJECT_ID.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJhbGci... (z Settings ‚Üí API ‚Üí service_role)
```

---

### 5Ô∏è‚É£ **W STRIPE WEBHOOK ENDPOINT:**

**Endpoint URL:**
```
https://TWOJ_PROJECT_ID.supabase.co/functions/v1/stripe-webhook
```

**Events (zaznacz te checkboxy):**
- ‚úÖ `checkout.session.completed`
- ‚úÖ `customer.subscription.created`
- ‚úÖ `customer.subscription.updated`
- ‚úÖ `customer.subscription.deleted`
- ‚úÖ `invoice.payment_succeeded`
- ‚úÖ `invoice.payment_failed`

**Gdzie:** https://dashboard.stripe.com/test/webhooks/create

---

## üÜò TROUBLESHOOTING

### Problem: "Stripe publishable key not found"
**RozwiƒÖzanie:**
1. Sprawd≈∫ czy `.env` istnieje w g≈Ç√≥wnym katalogu
2. Sprawd≈∫ czy klucz zaczyna siƒô od `VITE_STRIPE_PUBLISHABLE_KEY=pk_test_`
3. Zrestartuj dev server: `npm run dev`

### Problem: "Payment failed - no price ID"
**RozwiƒÖzanie:**
1. Sprawd≈∫ czy wszystkie 4 Price IDs sƒÖ w `.env`
2. Sprawd≈∫ czy zaczynajƒÖ siƒô od `price_`
3. Sprawd≈∫ w Stripe Dashboard czy produkty sƒÖ utworzone

### Problem: "Webhook signature verification failed"
**RozwiƒÖzanie:**
1. Sprawd≈∫ czy `STRIPE_WEBHOOK_SECRET` jest w Supabase Edge Functions settings
2. Sprawd≈∫ czy webhook endpoint URL jest poprawny
3. Sprawd≈∫ czy events sƒÖ zaznaczone

### Problem: "Subscription not updating in database"
**RozwiƒÖzanie:**
1. Sprawd≈∫ logi w Supabase: Edge Functions ‚Üí stripe-webhook ‚Üí Logs
2. Sprawd≈∫ czy `SUPABASE_SERVICE_ROLE_KEY` jest ustawiony
3. Sprawd≈∫ RLS policies w tabeli `workers`

---

## üìû WSPARCIE

Je≈õli co≈õ nie dzia≈Ça:
1. Sprawd≈∫ logi Supabase: **Edge Functions** ‚Üí **Logs**
2. Sprawd≈∫ logi Stripe: **Dashboard** ‚Üí **Developers** ‚Üí **Events**
3. Sprawd≈∫ console przeglƒÖdarki (F12)
4. Napisz dok≈Çadny komunikat b≈Çƒôdu

---

## üéâ GRATULACJE!

Je≈õli wszystkie testy przesz≈Çy pomy≈õlnie, masz w pe≈Çni dzia≈ÇajƒÖcy system abonamentowy! üöÄ

### Nastƒôpne kroki:
1. Przejd≈∫ na **Stripe LIVE mode** (gdy bƒôdziesz gotowy do produkcji)
2. Zmie≈Ñ klucze API na production (`pk_live_...`, `sk_live_...`)
3. Przetestuj z prawdziwymi p≈Çatno≈õciami (ma≈Çe kwoty)
4. Uruchom marketing! üí∞

---

**POWERED BY:** Supabase + Stripe + React + TypeScript  
**CZAS WDRO≈ªENIA:** ~45 minut  
**TRUDNO≈öƒÜ:** ≈örednia  
**STATUS:** ‚úÖ GOTOWE DO U≈ªYCIA
